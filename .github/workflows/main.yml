name: SSH-Ubuntu (Tailscale + Password)

on:
  workflow_dispatch:

jobs:
  insecure-ish-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Pasang & aktifkan OpenSSH
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openssh-server pwgen
          sudo systemctl enable ssh
          sudo systemctl restart ssh

      - name: Buat user + password acak
        env:
          SSH_USER: sshuser
        run: |
          set -e
          if ! id -u "$SSH_USER" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash "$SSH_USER"
          fi
          PASS=$(pwgen -s 20 1)
          echo "$SSH_USER:$PASS" | sudo chpasswd
          echo "SSH_CREDS=User: $SSH_USER | Password: $PASS" >> $GITHUB_ENV
          echo "$SSH_USER ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$SSH_USER >/dev/null
          sudo chmod 440 /etc/sudoers.d/$SSH_USER

      - name: Izinkan PasswordAuthentication (dibuka)
        run: |
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/g' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Install & Up Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${TS_AUTHKEY}" --hostname="gh-ubuntu-${GITHUB_RUN_ID}"
          TSIP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV

      - name: Verifikasi port 22
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          sudo apt-get install -y netcat-openbsd >/dev/null
          nc -zv "$TAILSCALE_IP" 22
          echo "TCP ke port 22 OK"

      - name: Info Koneksi & Keep-Alive
        run: |
          echo ""
          echo "=== SSH ACCESS (Tailscale) ==="
          echo "Address : $TAILSCALE_IP"
          echo "Creds   : $SSH_CREDS"
          echo "Command : ssh sshuser@$TAILSCALE_IP"
          echo "=============================="
          echo ""
          while true; do
            echo "[$(date)] SSH Active - Cancel workflow to stop"
            sleep 300
          done
